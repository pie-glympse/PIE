generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                            BigInt                @id @default(autoincrement())
  email                         String                @unique
  password                      String
  role                          String                @default("STANDARD")
  photoUrl                      String                @default("")
  firstName                     String                @default("")
  lastName                      String                @default("")
  companyId                     BigInt?
  teamId                        BigInt?
  hasSeenOnboarding             Boolean               @default(false)
  points                        Int                   @default(0)
  selectedBadgeId               BigInt?
  companyStats                  CompanyStats?
  Event_Event_createdByIdToUser Event[]               @relation("Event_createdByIdToUser")
  preferences                   EventUserPreference[]
  photos                        EventsUsersPhoto[]
  feedbacks                     Feedback[]
  notifications                 Notification[]
  PasswordResetToken            PasswordResetToken[]
  company                       Company?              @relation(fields: [companyId], references: [id])
  team                          Team?                 @relation(fields: [teamId], references: [id])
  votes                         Vote[]
  events                        Event[]               @relation("EventUsers")
  blacklistedPlaces             BlacklistedPlace[]
  userBadges                    UserBadge[]
  pointsHistory                 PointsHistory[]
  selectedBadge                 Badge?                @relation("SelectedBadge", fields: [selectedBadgeId], references: [id])
}

model Company {
  id                BigInt             @id @default(autoincrement())
  name              String
  teams             Team[]
  users             User[]
  blacklistedPlaces BlacklistedPlace[]
}

model Team {
  id        BigInt   @id @default(autoincrement())
  name      String
  companyId BigInt
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users     User[]
}

model Event {
  id                           BigInt                @id @default(autoincrement())
  title                        String
  maxPersons                   BigInt?
  costPerPerson                BigInt?
  state                        String                @default("PENDING")
  createdAt                    DateTime              @default(now())
  updatedAt                    DateTime
  uuid                         String                @unique @default(uuid())
  activityType                 String?
  city                         String?
  endDate                      DateTime?
  endTime                      DateTime?
  maxDistance                  Float?
  startDate                    DateTime?
  startTime                    DateTime?
  createdById                  BigInt?
  duration                     Int?
  recurring                    Boolean               @default(false)
  recurringRate                String?
  User_Event_createdByIdToUser User?                 @relation("Event_createdByIdToUser", fields: [createdById], references: [id])
  location                     EventLocation?
  preferences                  EventUserPreference[]
  photos                       EventsUsersPhoto[]
  feedbacks                    Feedback[]
  notifications                Notification[]
  votes                        Vote[]
  tags                         Tag[]                 @relation("EventTags")
  users                        User[]                @relation("EventUsers")
  blacklistedPlaces            BlacklistedPlace[]
}

model Tag {
  id          BigInt                @id
  name        String
  preferences EventUserPreference[]
  events      Event[]               @relation("EventTags")
}

model EventUserPreference {
  userId        BigInt
  eventId       BigInt
  preferredDate DateTime
  tagId         BigInt
  event         Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tag           Tag      @relation(fields: [tagId], references: [id])
  user          User     @relation(fields: [userId], references: [id])

  @@id([userId, eventId])
}

model EventsUsersPhoto {
  id        BigInt  @id @default(autoincrement())
  userId    BigInt
  eventId   BigInt
  photoUrl  String
  caption   String?
  createdAt BigInt
  event     Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Feedback {
  userId       BigInt
  eventId      BigInt
  rating       BigInt?
  message      String?
  participated Boolean?
  createdAt    DateTime @default(now())
  event        Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, eventId])
}

model Vote {
  userId    BigInt
  eventId   BigInt
  total     BigInt
  createdAt DateTime
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, eventId])
}

model EventLocation {
  eventId BigInt @unique
  id      BigInt @id
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
}

model CompanyStats {
  superAdminId BigInt @id
  totalPersons BigInt
  subscription String
  price        BigInt
  companyName  String
  superAdmin   User   @relation(fields: [superAdminId], references: [id])
}

model PasswordResetToken {
  id        BigInt    @id @default(autoincrement())
  token     String    @unique @db.VarChar(255)
  email     String    @db.VarChar(255)
  userId    BigInt
  expiresAt DateTime  @db.Timestamp(6)
  used      Boolean?  @default(false)
  createdAt DateTime? @default(now()) @db.Timestamp(6)
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([token])
}

model BlacklistedPlace {
  id          BigInt   @id @default(autoincrement())
  placeId     String // ID Google Places
  companyId   BigInt // Blacklist au niveau entreprise
  eventId     BigInt? // Optionnel : blacklist pour un événement spécifique (null = tous les événements)
  createdById BigInt
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  event       Event?   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([companyId, placeId])
  @@index([eventId, placeId])
  @@index([companyId, eventId])
}

model Notification {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt
  message   String
  read      Boolean  @default(false)
  type      String?
  eventId   BigInt?
  createdAt DateTime @default(now())
  event     Event?   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
}

// Définition des badges disponibles dans le système
model Badge {
  id              BigInt      @id @default(autoincrement())
  name            String      @unique
  description     String
  icon            String 
  pointsRequired  Int
  order           Int // Pour l'ordre d'affichage (1=Débutant, 2=Explorateur, etc.)
  createdAt       DateTime    @default(now())
  userBadges      UserBadge[]
  selectedByUsers User[]      @relation("SelectedBadge")

  @@index([pointsRequired])
}

// Table de liaison pour les badges débloqués par les utilisateurs
model UserBadge {
  userId      BigInt
  badgeId     BigInt
  unlockedAt  DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge       Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@id([userId, badgeId])
  @@index([userId])
}

// Historique des points gagnés/perdus
model PointsHistory {
  id          BigInt   @id @default(autoincrement())
  userId      BigInt
  points      Int // Positif = gagné, négatif = perdu
  action      String // Type d'action: "event_participation", "feedback_given", "event_created", etc.
  description String? // Description optionnelle
  eventId     BigInt? // Référence optionnelle à l'événement concerné
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}
